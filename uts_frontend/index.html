<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Sensor IoT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #74ABE2, #5563DE);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            color: #fff;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        #realtime-data {
            margin-bottom: 30px;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #realtime-data h2 {
            margin-bottom: 15px;
        }

        #realtime-values {
            display: flex;
            gap: 25px;
            justify-content: center;
            font-size: 20px;
        }

        #control-panel {
            margin-top: 20px;
        }

        .relay-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            transition: 0.3s;
        }

        #btn-on {
            background: #28a745; /* Green */
            color: white;
        }

        #btn-off {
            background: #dc3545; /* Red */
            color: white;
        }
        
        .card-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            min-width: 160px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .card p {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Perbaikan Tampilan Tabel */
        table {
            border-collapse: separate; 
            border-spacing: 0 5px; 
            width: 95%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 50px; /* Tambah margin bawah */
        }

        th {
            background: #4A56B8;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 10px 12px;
            text-align: left;
            background: #ffffff;
        }
        
        tr {
            transition: 0.3s;
        }
        tr:hover td {
            background: #e6e6e6;
        }
    </style>
</head>
<body>
    <h1>üå°Ô∏è Dashboard Data Sensor IoT</h1>

    <div id="realtime-data">
        <h2>Data Real-time (Wokwi) <span id="mqtt-status">‚ùå Disconnected</span></h2>
        <div id="realtime-values">
            <p>Suhu: <span id="realtime_suhu">--</span> ¬∞C</p>
            <p>Kelembapan: <span id="realtime_kelembapan">--</span> %</p>
            <p>Cahaya (Lux): <span id="realtime_lux">--</span></p>
        </div>
        <div id="control-panel">
            <button id="btn-on" class="relay-btn" onclick="sendCommand('ON')">POMPA ON</button>
            <button id="btn-off" class="relay-btn" onclick="sendCommand('OFF')">POMPA OFF</button>
        </div>
    </div>

    <div class="card-container">
        <div class="card">
            <h3>Suhu Maks (DB)</h3>
            <p id="suhumax">-</p>
        </div>
        <div class="card">
            <h3>Suhu Min (DB)</h3>
            <p id="suhumin">-</p>
        </div>
        <div class="card">
            <h3>Rata-rata Suhu (DB)</h3>
            <p id="suhurata">-</p>
        </div>
    </div>
    
    <div style="margin-bottom: 20px;">
        <button class="relay-btn" style="background: #3498db;" onclick="loadDataHistoris()">
            Refresh Data Historis
        </button>
    </div>
    
    <h2>Riwayat Data Historis (Log Terbaru di Atas)</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Suhu (¬∞C)</th>
                <th>Kelembapan (%)</th>
                <th>Kecerahan (Lux)</th>
                <th>Waktu</th>
            </tr>
        </thead>
        <tbody id="tabelData"></tbody>
    </table>

    <script>
        // --- Bagian A: Data Historis (Database/PHP) ---

        async function loadDataHistoris() {
            try {
                // Fetch data dari PHP (yang sekarang sudah diurutkan DESC/terbaru di atas)
                const response = await fetch('http://localhost/uts_backend/data_sensor.php');
                const data = await response.json();

                // 1. Update Kartu Statistik
                document.getElementById('suhumax').textContent = data.suhumax || 0;
                document.getElementById('suhumin').textContent = data.suhumin || 0;
                document.getElementById('suhurata').textContent = (data.suhurata || 0).toFixed(2);

                // 2. Update Tabel Log
                const tbody = document.getElementById('tabelData');
                tbody.innerHTML = ''; // Kosongkan tabel sebelum isi data
                
                // data.nilai_suhu_max_humid_max berisi semua data log, terbaru di atas
                data.nilai_suhu_max_humid_max.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.suhu}</td>
                        <td>${item.humidity}</td>
                        <td>${item.lux}</td>
                        <td>${item.timestamp}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching historical data:', error);
            }
        }

        // --- Bagian B: Data Real-time (MQTT/Wokwi) ---

        // Konfigurasi MQTT (Port 8000 untuk WebSocket ke HiveMQ)
        const host = "broker.hivemq.com";
        const port = 8000; 
        const path = "/mqtt";
        const clientId = "webClient_" + parseInt(Math.random() * 1000, 10);
        
        const topicSubscribe = "projekIoT/sensor";
        const topicPublish = "projekIoT/pompa";

        const client = new Paho.MQTT.Client(host, port, path, clientId);
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        
        function onConnect() {
            document.getElementById('mqtt-status').textContent = '‚úÖ Connected';
            document.getElementById('mqtt-status').style.color = 'lightgreen';
            console.log("MQTT Connected!");
            client.subscribe(topicSubscribe);
        }
        
        function onFailure(responseObject) {
            document.getElementById('mqtt-status').textContent = '‚ùå Connection Failed';
            document.getElementById('mqtt-status').style.color = 'red';
            console.log("Connection failed: " + responseObject.errorMessage);
        }

        function onConnectionLost(responseObject) {
            document.getElementById('mqtt-status').textContent = '‚ùå Lost';
            document.getElementById('mqtt-status').style.color = 'red';
            console.log("Connection lost: " + responseObject.errorMessage);
        }

        function onMessageArrived(message) {
            const payload = message.payloadString;
            
            if (message.destinationName === topicSubscribe) {
                try {
                    const data = JSON.parse(payload); 
                    
                    // Update tampilan data real-time, termasuk Lux
                    document.getElementById("realtime_suhu").textContent = data.suhu;
                    document.getElementById("realtime_kelembapan").textContent = data.kelembapan;
                    document.getElementById("realtime_lux").textContent = data.lux;
                    
                } catch (e) {
                    console.error("Failed to parse JSON:", payload);
                }
            }
        }
        
        function sendCommand(command) {
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(command);
                message.destinationName = topicPublish;
                client.send(message);
                
                const status = document.createElement('span');
                status.textContent = ` [Pompa: ${command}]`;
                status.style.fontWeight = 'normal';
                
                const panel = document.getElementById('control-panel');
                panel.appendChild(status);
                setTimeout(() => panel.removeChild(status), 2000); 
            } else {
                alert("Koneksi MQTT belum siap. Coba refresh atau periksa Wokwi.");
            }
        }
        
        // Panggil fungsi saat halaman dimuat
        window.onload = function() {
            loadDataHistoris(); // Load data historis saat pertama kali buka
            
            // Inisialisasi MQTT client
            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: false,
            });
        };
    </script>
</body>
</html>